---
name: Fix Unrestricted File Upload Vulnerability
overview: Implement comprehensive file upload validation to prevent malicious file uploads. The current system accepts JavaScript files as images because it only validates MIME types (which can be spoofed). We'll add strict validation including file extension checks, MIME type verification, content inspection, filename sanitization, and secure storage practices.
todos:
  - id: create-file-validation-service
    content: Create FileValidationService with methods for image/document validation, content verification, and filename sanitization
    status: completed
  - id: update-event-image-validation
    content: Update EventController, FreeEventController, and TicketedEventController to use FileValidationService for event image uploads
    status: completed
    dependencies:
      - create-file-validation-service
  - id: update-profile-image-validation
    content: Update UserController and GuestController to use FileValidationService for profile image uploads
    status: completed
    dependencies:
      - create-file-validation-service
  - id: update-organizer-logo-validation
    content: Update OrganizerController to use FileValidationService for logo uploads
    status: completed
    dependencies:
      - create-file-validation-service
  - id: update-document-validation
    content: Update all document upload endpoints (MessageController, VendorController, etc.) to use FileValidationService
    status: completed
    dependencies:
      - create-file-validation-service
  - id: implement-content-verification
    content: Implement actual file content verification using getimagesize() for images and finfo_file() for documents
    status: completed
    dependencies:
      - create-file-validation-service
  - id: implement-filename-sanitization
    content: Implement filename sanitization to prevent path traversal and dangerous characters
    status: completed
    dependencies:
      - create-file-validation-service
  - id: secure-file-storage
    content: Ensure files are stored in non-executable directories with proper permissions
    status: completed
  - id: add-frontend-validation
    content: Add client-side file type and size validation in frontend upload components
    status: completed
  - id: test-malicious-uploads
    content: Test that JavaScript, PHP, and other malicious files are rejected when uploaded as images
    status: pending
    dependencies:
      - update-event-image-validation
      - update-profile-image-validation
  - id: test-valid-uploads
    content: Test that valid image and document uploads still work correctly
    status: pending
    dependencies:
      - update-event-image-validation
      - update-profile-image-validation
      - update-document-validation
---

# F

ix Unrestricted File Upload Vulnerability

## Problem Analysis

The application currently accepts file uploads with minimal validation. The vulnerability shows that a JavaScript file (`sample1.js`) was successfully uploaded as an event image. The current validation uses Laravel's `image` rule which only checks MIME types, which can be easily spoofed.**Current Vulnerable Endpoints:**

- Event image uploads (`EventController`, `FreeEventController`, `TicketedEventController`)
- Profile image uploads (`UserController`, `GuestController`)
- Organizer logo uploads (`OrganizerController`)
- Message attachments (`MessageController`)
- Custom field file uploads (`EventController`)
- Vendor documents (`VendorController`, `VendorQuotationController`)
- Product documents (`ProductController`)
- Contract files (`VendorContractController`)
- Salesperson documents (`SalespersonRegistrationController`)

**Current Issues:**

1. Only MIME type validation (spoofable)
2. No file extension validation
3. No content verification (actual file type checking)
4. Filenames not sanitized
5. Files stored in public directories (potentially executable)
6. No file size limits in some endpoints

## Implementation Plan

### Phase 1: Create Centralized File Validation Service

**File: `validity_backend/app/Services/FileValidationService.php`** (NEW)Create a comprehensive file validation service that:

1. **Validates file extensions** - Whitelist approach
2. **Validates MIME types** - Cross-reference with extensions
3. **Verifies file content** - Use `getimagesize()` for images, `finfo_file()` for others
4. **Sanitizes filenames** - Remove dangerous characters, prevent path traversal
5. **Enforces size limits** - Configurable per file type
6. **Returns detailed validation results** - For better error messages

**Key Methods:**

- `validateImage(UploadedFile $file, array $options = [])` - For image uploads
- `validateDocument(UploadedFile $file, array $options = [])` - For document uploads
- `sanitizeFilename(string $filename)` - Sanitize and secure filenames
- `verifyFileContent(UploadedFile $file, string $expectedType)` - Content verification

**Allowed File Types:**

- **Images:** jpg, jpeg, png, gif, webp (with content verification)
- **Documents:** pdf, doc, docx, xls, xlsx (with content verification)
- **Size Limits:** 
- Images: 2MB (2048KB) - already enforced
- Documents: 5MB - configurable

### Phase 2: Update Event Image Upload Validation

**Files to Modify:**

- `validity_backend/app/Http/Controllers/EventController.php`
- `validity_backend/app/Http/Controllers/FreeEventController.php`
- `validity_backend/app/Http/Controllers/TicketedEventController.php`

**Changes:**

1. Replace `'nullable|image|max:2048'` with custom validation using `FileValidationService`
2. Add explicit extension whitelist: `['jpg', 'jpeg', 'png', 'gif', 'webp']`
3. Verify actual image content using `getimagesize()` or Intervention Image
4. Sanitize filename before storage
5. Store in non-executable directory (already using `public` disk, but ensure proper permissions)

**Example Implementation:**

```php
if ($request->hasFile('event_image')) {
    $file = $request->file('event_image');
    $validation = app(FileValidationService::class)->validateImage($file, [
        'max_size' => 2048, // KB
        'allowed_extensions' => ['jpg', 'jpeg', 'png', 'gif', 'webp']
    ]);
    
    if (!$validation['valid']) {
        return response()->json(['error' => $validation['message']], 422);
    }
    
    $sanitizedFilename = app(FileValidationService::class)->sanitizeFilename($file->getClientOriginalName());
    $data['event_image'] = $file->storeAs('event_images', $sanitizedFilename, 'public');
}
```



### Phase 3: Update Profile Image Upload Validation

**Files to Modify:**

- `validity_backend/app/Http/Controllers/UserController.php`
- `validity_backend/app/Http/Controllers/GuestController.php`

**Changes:**

- Use `FileValidationService` for profile image validation
- Same strict validation as event images

### Phase 4: Update Organizer Logo Upload Validation

**File: `validity_backend/app/Http/Controllers/OrganizerController.php`Changes:**

- Use `FileValidationService` for logo validation
- Ensure logos are actual images

### Phase 5: Update Document Upload Validation

**Files to Modify:**

- `validity_backend/app/Http/Controllers/MessageController.php` - Already has some validation, enhance it
- `validity_backend/app/Http/Controllers/EventController.php` - Custom field file uploads
- `validity_backend/app/Http/Controllers/VendorController.php`
- `validity_backend/app/Http/Controllers/VendorQuotationController.php`
- `validity_backend/app/Http/Controllers/ProductController.php`
- `validity_backend/app/Http/Controllers/VendorContractController.php`
- `validity_backend/app/Http/Controllers/SalespersonRegistrationController.php`

**Changes:**

- Use `FileValidationService::validateDocument()` for document uploads
- Whitelist allowed document types
- Verify content using `finfo_file()`
- Enforce size limits

### Phase 6: Secure File Storage

**File: `validity_backend/config/filesystems.php`Changes:**

1. Ensure upload directories are not executable
2. Store sensitive files in `local` disk (not `public`)
3. Add `.htaccess` or server configuration to prevent execution in upload directories
4. Use unique, sanitized filenames to prevent overwrites

**Storage Strategy:**

- **Public images** (event images, profile images): `public` disk with proper permissions
- **Sensitive documents** (contracts, resumes): `local` disk (not web-accessible)
- **Message attachments**: Already using configurable disk

### Phase 7: Add Content Verification

**Enhancement to FileValidationService:**

1. **For Images:**

- Use `getimagesize()` to verify actual image format
- Use Intervention Image to attempt loading (catches corrupted/spoofed files)
- Verify MIME type matches file content

2. **For Documents:**

- Use `finfo_file()` with `FILEINFO_MIME_TYPE` to detect actual file type
- Compare detected type with declared MIME type
- Reject if mismatch detected

### Phase 8: Filename Sanitization

**Implementation in FileValidationService:**

1. Remove path traversal attempts (`../`, `..\\`)
2. Remove null bytes
3. Remove special characters that could cause issues
4. Limit filename length
5. Generate unique filenames using timestamp + hash
6. Preserve safe extension

**Example:**

```php
public function sanitizeFilename(string $filename): string
{
    // Remove path traversal
    $filename = str_replace(['../', '..\\', '/', '\\'], '', $filename);
    
    // Remove null bytes
    $filename = str_replace("\0", '', $filename);
    
    // Get extension
    $extension = pathinfo($filename, PATHINFO_EXTENSION);
    $name = pathinfo($filename, PATHINFO_FILENAME);
    
    // Sanitize name (alphanumeric, dash, underscore only)
    $name = preg_replace('/[^a-zA-Z0-9_-]/', '', $name);
    $name = substr($name, 0, 50); // Limit length
    
    // Generate unique filename
    return time() . '_' . uniqid() . '_' . $name . '.' . strtolower($extension);
}
```



### Phase 9: Frontend Validation (Defense in Depth)

**Files to Modify:**

- `event-horizon-dashboards/src/pages/CreateFreeEvent.tsx`
- `event-horizon-dashboards/src/pages/CreateTicketedEvent.tsx`
- Any other components with file uploads

**Changes:**

- Add file type validation before upload
- Check file extension client-side
- Check file size client-side
- Show user-friendly error messages

**Note:** Frontend validation is for UX only - backend validation is mandatory.

### Phase 10: Add Security Headers for Uploaded Files

**File: `validity_backend/public/.htaccess` or server configChanges:**

- Add headers to prevent execution of uploaded files
- Set proper Content-Type headers
- Disable script execution in upload directories

## Testing Strategy

1. **Test malicious file uploads:**

- Upload JavaScript file as image → Should be rejected
- Upload PHP file as image → Should be rejected
- Upload file with spoofed MIME type → Should be rejected
- Upload file with double extension (e.g., `image.jpg.php`) → Should be rejected
- Upload file with null bytes in filename → Should be sanitized/rejected

2. **Test valid uploads:**

- Upload valid images → Should work
- Upload valid documents → Should work
- Verify files are stored correctly
- Verify filenames are sanitized

3. **Test edge cases:**

- Very large files → Should be rejected
- Empty files → Should be rejected
- Corrupted image files → Should be rejected

## Rollout Considerations

1. **Backward compatibility:** Existing uploaded files will remain, but new uploads will be strictly validated
2. **Error messages:** Provide clear, user-friendly error messages when validation fails
3. **Performance:** Content verification adds minimal overhead but improves security significantly
4. **Migration:** No database changes needed, only validation logic

## Files to Create/Modify

**New Files:**

1. `validity_backend/app/Services/FileValidationService.php`

**Modified Files:**

1. `validity_backend/app/Http/Controllers/EventController.php`
2. `validity_backend/app/Http/Controllers/FreeEventController.php`
3. `validity_backend/app/Http/Controllers/TicketedEventController.php`
4. `validity_backend/app/Http/Controllers/UserController.php`
5. `validity_backend/app/Http/Controllers/GuestController.php`
6. `validity_backend/app/Http/Controllers/OrganizerController.php`
7. `validity_backend/app/Http/Controllers/MessageController.php`
8. `validity_backend/app/Http/Controllers/VendorController.php`
9. `validity_backend/app/Http/Controllers/VendorQuotationController.php`
10. `validity_backend/app/Http/Controllers/ProductController.php`
11. `validity_backend/app/Http/Controllers/VendorContractController.php`
12. `validity_backend/app/Http/Controllers/SalespersonRegistrationController.php`
13. `validity_backend/config/filesystems.php` (if needed)
14. `event-horizon-dashboards/src/pages/CreateFreeEvent.tsx` (frontend validation)
15. `event-horizon-dashboards/src/pages/CreateTicketedEvent.tsx` (frontend validation)

## Risk Mitigation

- **Low risk:** Changes only add validation, don't remove functionality
- **Backward compatible:** Existing files remain accessible